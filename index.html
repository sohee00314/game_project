<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Going Home at Night</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/Maps.js"></script>
    <script src="js/GamePlatform.js"></script>
    <script src="js/Character.js"></script>
    <script src="lib/common.js"></script>
    <script src="js/Sensor.js"></script>
    <script src="js/UpSensor.js"></script>
    <script src="js/RightSensor.js"></script>
    <script src="js/DownSensor.js"></script>
    <script src="js/LeftSensor.js"></script>
    <script>
    let level = 0; 
    let map = maps[level];
    let character;
    let platAarray = Array.from({length:20},()=>Array(30).fill(0));
    let arrP = [];
    let stage;
    let speed = 5;
    let st =null;
    let firstX;
    let firstY;
    // 발판생성
    function createPF(level){
        for(let i =0;i<map.length;i++){
            for(let j=0;j<map[i].length;j++){
                stage = document.getElementById("stage");
                    if(map[i][j] ==1){
                      let plate= new GamePlatfrom(stage,j*100,i*100,100,100,"red");
                      arrP.push(plate);
                      platAarray[i][j] = plate;
                    }
                    if(map[i][j] ==2){
                        firstX = j*100;
                        firstY = i*100;
                        character = new Character(stage,firstX,firstY,90,100,0,0,"lightblue");
                    }
                }
            }
        }
        function gameLoop(){
            character.tick();
            character.render();

            if(character.x>=2900){
                nextMap();
            }
            
        }
        function play(){
            if(st==null){
                st = setInterval(gameLoop,10);
            } else{
                clearInterval(st);
                st =null;
            }

        }
        function jump(){

            if(character.jumping == false){
                character.jumping = true
            }
            else{
                character.jumping = false;
            }

        }
        function nextMap(){
            /*
            if(stage.contains(character.div)){
                stage.removeChild(character.div);
            }
            */
            // for(let i= arrP.lengt-1; i>=0; i--){
            //     if(stage.contains(arrP[i].div)){
            //         stage.removeChild(arrP[i].div);
            //     }
            //     arrP.splice(0,1);
            // }
            /*
            for(let i = arrP.length - 1; i >= 0; i--){
                if(stage.contains(arrP[i].div)){
                    stage.removeChild(arrP[i].div);
                }
                arrP.splice(i, 1);
            }
            */
            
            //클리어된 스테이지 발판 제거
            for(let i=0;i<platAarray.length;i++){
                for(let a=0;a<platAarray[i].length;a++){
                    let plat=platAarray[i][a];
                    if(plat !=0){
                        stage.removeChild(plat.div);
                    }
                }
            };
            platAarray = Array.from({length:20},()=>Array(30).fill(0));  

            if(level<=maps.length){
                ++level;
                map = maps[level];
                // platAarray = Array.from({length:20},()=>Array(30).fill(0));                
                createPF(level);
            } else{
                alert("END");
            }
        }

        function init(){
            createPF(level);
            addEventListener("keydown",function(e){
                switch(e.keyCode){
                    case 32 : 
                    (character.downSensor.result)? jump() : console.log("점프중"); 
                    break;// 점프기능 추가 필요
                    case 39 :character.velX= speed; break;
                   // case 40 :character.velY= speed; break; 
                    case 37 :character.velX= -speed; break;
                    case 27 : play(); break;
                }
            });
            addEventListener("keyup",function(e){
                switch(e.keyCode){
                   // case 38 :character.jumping = false; break;
                    case 39 :character.velX= 0; break;
                   // case 40 :character.velY= 0; break;
                    case 37 :character.velX= 0; break;
                }
            });

        }
        addEventListener("load",function(){
            init();
        });
    </script>
</head>
<body>
    <div id="stage"></div>
</body>
</html>